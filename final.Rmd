---
title: "Chess Project"
output: html_document
date: "2024-10-20"
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(colorspace)
```

```{r functions, include=FALSE}
square_to_pos <- function(square) {
  # Calculate the x and y positions
  x <- (square %% 8) + 1
  y <- (square %/% 8) + 1
  return(c(x, y))
}

flip_square_pos <- function(square) {
  # Flip
  square <- 63 - square
  # Calculate the x and y positions
  x <- (square %% 8) + 1
  y <- (square %/% 8) + 1
  return(c(x, y))
}
```

## Common Moves

```{r moves, echo=FALSE}
moves <- read.csv("UseableCSV/move_count.csv")

# Turn square to pos
moves <- moves %>%
  rowwise() %>%
  mutate(pos = if_else(player == "black", list(flip_square_pos(square)), list(square_to_pos(square)))) %>%
  unnest_wider(pos, names_sep = "_") %>%
  rename(x = pos_1, y = pos_2)

moves$player <- factor(moves$player, levels = c("white", "black"))

renderPlot({
  ggplot(moves, aes(x = x, y = y, fill=count)) +
    geom_tile(color="black") +
    scale_x_continuous(breaks = 1:8, labels = c("a", "b", "c", "d", "e", "f", "g", "h")) +
    scale_y_continuous(breaks = 1:8) +
    coord_fixed() +
    scale_fill_gradient(low = "skyblue", high = "red") +
    theme_void() +
    facet_wrap(~player) +
    labs(title = "Where to players move", subtitle = "Most common moves, seperated by player", caption = "Both are from the perspective of thier own player")
})
```
I realized that this graphic actually is best separated by players. Notice g1 and g8. It appears king side castling is more popular then queen side. Anywho because of this I will be keeping both graphs. This also is not terribly surprising as people love the center four squares, and supporting with kings knight or just another pawn in that f3, f6 space.


## Castling
```{r, echo=FALSE}
castles <- read.csv("UseableCSV/castle_counts.csv")

castles$side <- factor(castles$side, levels = c("Queen", "King"))

renderPlot({
  ggplot(castles, aes(x = side, y = count, fill = player)) +
    geom_bar(stat = "identity", color="black", position = position_dodge(width = 0.7), width = 0.6) +
    coord_flip() +
    labs(
        title = "Counts of King and Queen Sides by Player",
        x = "Side",
        y = "Count"
    ) +
    theme_bw() +
    scale_fill_manual(values = c("white" = "white", "black" = "black")) +
    labs(title = "Who be Castling", subtitle = "Still seperated by players", caption = "Right after I made this my friend who was playing white castled king side. They can't beat statsistics.")
})
```
Well that checks out with what we saw above. King side is much more popular. Additionally it seems that White tends to castle more. Maybe black then plays around white castling and won't do it themselves.


## Common Captures
```{r captures, echo=FALSE}
captures <- read.csv("UseableCSV/captures.csv")

inputPanel(
  selectInput("cap_player", label = "Player:",
              choices = c("white", "black", "Both"), selected = "Both"),
  
  selectInput("piece", label = "Capturing Piece:",
              choices = c('pawn', 'rook', 'bishop', 'knight', 'queen', 'king'), selected = "pawn")
)

renderPlot({
  if (input$cap_player == "Both") {
    sub_caption = "both player's"
  } else if (input$cap_player == "white") {
    sub_caption = "White's"
  } else {
    sub_caption = "Black's"
  }
  
  filtered_data <- captures %>%
    filter(piece_moved == input$piece)
    
  cap_max <- filtered_data %>%
    group_by(piece_taken) %>%
    summarise(total_count = sum(count)) %>%
    summarise(max_count = max(total_count)) %>%
    pull(max_count)
  
  filtered_data <- filtered_data %>%
    filter(input$cap_player == "Both" | player == input$cap_player)
  
  ggplot(filtered_data, aes(x = reorder(piece_taken, -count), y = count)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    ylim(0, cap_max) +
    labs(x = "Piece Taken", y = "Count", title = "What piece dies the most (to another piece)?", subtitle = paste("Captures from", sub_caption, input$piece), caption = "Scales are based off the maximum number of a certain piece captures by both players.") +
    theme(axis.text.x = element_text(size = 14))
})
```


## Check Moves
This is whenever there is a check and what piece was moved that made a check.

```{r checksOrigins, echo=FALSE}
# Get Data
check_o <- read.csv("UseableCSV/check_origins.csv")

# - Get king square
check_o <- check_o %>%
  rowwise() %>%
  mutate(pos = list(square_to_pos(king_pos))) %>%
  unnest_wider(pos, names_sep = "_") %>%
  rename(x = pos_1, y = pos_2)

# - Get check from square
check_o <- check_o %>%
  rowwise() %>%
  mutate(pos = list(square_to_pos(check_square))) %>%
  unnest_wider(pos, names_sep = "_") %>%
  rename(check_x = pos_1, check_y = pos_2)


# Input
inputPanel(
  # Player
  selectInput("check_player", label = "Player:",
              choices = c("white", "black", "both"), selected = "white"),
  
  # x (row)
  selectInput("x_coord", "Select X (Row):", choices = 1:8),
  
  # y (column)
  selectInput("y_coord", "Select Y (Col):", choices = 1:8)
)

renderPlot({
  # Get King at x, y and player
  filtered_data <- check_o %>%
    filter((player == input$check_player) & 
             x == input$x_coord &
             y == input$y_coord)

  # Color King square
  # ?
  
  ggplot(filtered_data, aes(x = check_x, y = check_y, fill=count)) +
    geom_tile() +
    coord_fixed() +
    labs(title = paste("Check with King at", input$x_coord, ",", input$y_coord)) +
    theme_minimal()
})
```

